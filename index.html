<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TreeOfLifa - Naturliga Luffasvampar</title>

    <!-- Stripe SDK -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=test&currency=SEK"></script>

    <style>
        /* ===== Reset & Base ===== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html,body { height: 100%; }
        body {
            font-family: 'Georgia', serif;
            color: #2d4a2b;
            background: #fefefe;
            -webkit-font-smoothing: antialiased;
        }

        /* ===== Page Navigation ===== */
        .page {
            display: none;
            min-height: calc(100vh - 160px);
        }
        .page.active {
            display: block;
        }

        /* ===== Header / Nav ===== */
        header {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.96);
            backdrop-filter: blur(6px);
            box-shadow: 0 2px 18px rgba(0,0,0,0.06);
            z-index: 1200;
        }
        nav {
            max-width: 1200px; margin: 0 auto;
            padding: 1rem 5%; display: flex; align-items: center; justify-content: space-between;
        }
        .logo { 
            font-size: 1.6rem; font-weight: 700; color: #4a7c59; 
            text-decoration: none; display: flex; align-items: center; gap: 8px; 
            cursor: pointer;
        }
        .logo::before { content: "🌿"; }

        .nav-links { 
            display: flex; gap: 1.2rem; list-style: none; 
        }
        .nav-links a { 
            text-decoration: none; color: #2d4a2b; font-weight: 500; 
            cursor: pointer; transition: color 0.3s ease;
        }
        .nav-links a:hover { color: #4a7c59; }
        .menu-toggle { 
            display: none; background: none; border: none; 
            font-size: 1.6rem; cursor: pointer; 
        }

        .cart-icon { 
            position: relative; cursor: pointer; font-size: 1.4rem; 
            margin-left: 10px; transition: transform 0.3s ease;
        }
        .cart-icon:hover { transform: scale(1.1); }
        .cart-count { 
            position: absolute; top: -8px; right: -10px; 
            background: #ff6b6b; color: #fff; width: 20px; height: 20px; 
            border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; font-weight: 700; font-size: 0.8rem; 
        }

        /* ===== Hero ===== */
        .hero { 
            padding-top: 100px; min-height: 60vh; 
            display: flex; align-items: center; justify-content: center; 
            text-align: center; 
            background: linear-gradient(135deg, #f8fffe 0%, #e8f5e8 100%); 
        }
        .hero h1 { 
            font-size: 2.6rem; font-weight: 300; color: #2d4a2b; 
            margin-bottom: 0.6rem; 
        }
        .hero .subtitle { 
            font-style: italic; color: #5a7c5a; margin-bottom: 1rem; 
        }

        .cta-button {
            display: inline-block; padding: 0.8rem 2rem; border-radius: 40px;
            background: linear-gradient(135deg, #4a7c59 0%, #7fb069 100%); 
            color: #fff; text-decoration: none; cursor: pointer;
            box-shadow: 0 8px 22px rgba(74,124,89,0.24);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none; font-family: inherit; font-size: inherit;
        }
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(74,124,89,0.3);
        }

        /* ===== Sections ===== */
        .section { 
            max-width: 1200px; margin: 0 auto; padding: 2.5rem 5%; 
        }
        .section h2 { 
            font-size: 1.9rem; color: #2d4a2b; text-align: center; 
            margin-bottom: 0.8rem; 
        }
        .section p { 
            text-align: center; max-width: 820px; margin: 0 auto; 
            color: #4a5a4a; line-height: 1.6;
        }

        /* ===== Products grid ===== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.25rem;
            margin-top: 1.2rem;
        }
        .product-card {
            background: #fff; border-radius: 14px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.06);
            overflow: hidden; display: flex; flex-direction: column;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }
        .product-card:hover { 
            transform: translateY(-6px); 
            box-shadow: 0 14px 40px rgba(0,0,0,0.08); 
        }

        .product-image { 
            width: 100%; height: 220px; 
            background: linear-gradient(135deg, #e8f5e8 0%, #d4e6d4 100%); 
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; 
        }
        .product-image img { 
            width: 100%; height: 100%; object-fit: cover; display: block; 
        }
        .product-image.no-image {
            font-size: 3rem; color: #4a7c59;
        }

        .product-info { 
            padding: 1rem 1.2rem; display: flex; flex-direction: column; 
            gap: 0.6rem; flex: 1; 
        }
        .product-info h3 { font-size: 1.05rem; color: #2d4a2b; }
        .product-info p { 
            color: #5a7c5a; font-size: 0.95rem; line-height: 1.4; 
        }
        .price { color: #4a7c59; font-weight: 700; margin-top: auto; }

        .buy-button {
            margin-top: 0.8rem; padding: 0.9rem; width: 100%; 
            border-radius: 22px; border: none;
            background: linear-gradient(135deg, #4a7c59 0%, #7fb069 100%); 
            color: white; cursor: pointer; font-family: inherit;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .buy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74,124,89,0.3);
        }

        /* ===== Cart sidebar ===== */
        .cart-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.45); 
            z-index: 1300; display: none; 
        }
        .cart-overlay.show { display: block; }
        
        .cart-sidebar { 
            position: fixed; top: 0; right: -420px; width: 400px; 
            height: 100vh; background: #fff; 
            box-shadow: -6px 0 30px rgba(0,0,0,0.12); 
            transition: right 0.22s ease; z-index: 1350; 
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .cart-sidebar.open { right: 0; }
        
        .cart-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 1rem; border-bottom: 1px solid #eee; 
        }
        .cart-content { 
            padding: 1rem; flex: 1; overflow-y: auto;
        }
        .cart-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0.8rem 0; border-bottom: 1px solid #f2f2f2; 
        }
        .quantity-controls { 
            display: flex; align-items: center; gap: 0.5rem; 
        }
        .quantity-btn { 
            width: 30px; height: 30px; border-radius: 50%; border: none; 
            background: #f0f0f0; cursor: pointer; 
            transition: background-color 0.2s ease;
        }
        .quantity-btn:hover {
            background: #e0e0e0;
        }

        .cart-total { 
            padding: 1rem; border-top: 2px solid #eee; text-align: center; 
        }
        .checkout-button {
            width: 100%; padding: 0.9rem; border-radius: 12px; border: none;
            background: linear-gradient(135deg, #4a7c59 0%, #7fb069 100%); 
            color: white; cursor: pointer; font-weight: 700; font-family: inherit;
            transition: transform 0.2s ease;
        }
        .checkout-button:hover {
            transform: translateY(-2px);
        }

        /* ===== Checkout modal ===== */
        .checkout-modal { 
            position: fixed; inset: 0; display: none; 
            align-items: center; justify-content: center; 
            background: rgba(0,0,0,0.6); z-index: 1400; padding: 20px; 
        }
        .checkout-modal.show { display: flex; }
        .checkout-content { 
            width: 520px; max-width: 100%; max-height: 90vh; overflow: auto; 
            background: #fff; border-radius: 12px; padding: 1rem 1.2rem; 
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block; margin-bottom: 0.5rem; font-weight: 500;
        }
        .form-group input, .form-group select { 
            width: 100%; padding: 0.7rem; border-radius: 8px; 
            border: 2px solid #e8e8e8; font-family: inherit;
        }

        .payment-method { 
            display: flex; gap: 0.7rem; align-items: center; 
            padding: 0.8rem; border-radius: 10px; border: 2px solid #e8e8e8; 
            margin-bottom: 0.6rem; cursor: pointer; 
            transition: all 0.2s ease;
        }
        .payment-method:hover {
            border-color: #4a7c59;
        }
        .payment-method.selected { 
            border-color: #4a7c59; background: #f8fffe; 
        }

        .card-row {
            display: flex; gap: 0.5rem; margin-top: 0.5rem;
        }
        .card-row input {
            flex: 1;
        }

        .order-button {
            width: 100%; padding: 0.9rem; border-radius: 12px; border: none;
            background: linear-gradient(135deg, #4a7c59 0%, #7fb069 100%); 
            color: white; font-weight: 700; cursor: pointer; font-family: inherit;
            transition: transform 0.2s ease;
        }
        .order-button:hover {
            transform: translateY(-2px);
        }

        .close-cart {
            background: none; border: none; font-size: 1.5rem; 
            cursor: pointer; color: #666; transition: color 0.2s ease;
        }
        .close-cart:hover {
            color: #333;
        }

        /* ===== Footer ===== */
        footer { 
            background: #2d4a2b; color: #fff; padding: 2rem 5%; margin-top: 2rem; 
        }
        .footer-content { 
            max-width: 1200px; margin: 0 auto; text-align: center; 
        }

        /* ===== Success message ===== */
        .success-message {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #4a7c59; color: white; padding: 2rem; border-radius: 12px;
            text-align: center; z-index: 1500; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        /* ===== Error/Status messages ===== */
        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        .info-message {
            background: #4a7c59;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        /* ===== Payment status indicators ===== */
        .payment-processing {
            opacity: 0.7;
            pointer-events: none;
        }

        /* ===== Stripe Elements styling ===== */
        #card-element {
            padding: 0.7rem; 
            border: 2px solid #e8e8e8; 
            border-radius: 8px; 
            background: white;
            min-height: 40px;
        }

        #card-element.StripeElement--focus {
            border-color: #4a7c59;
            box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.1);
        }

        #card-element.StripeElement--invalid {
            border-color: #fa755a;
        }

        #card-errors {
            color: #fa755a;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        /* ===== Responsive ===== */
        @media (max-width: 900px) {
            .product-image { height: 200px; }
            .checkout-content { width: 92%; }
        }
        
        @media (max-width: 768px) {
            .nav-links { 
                display: none; position: absolute; top: 64px; right: 12px; 
                background: #fff; flex-direction: column; padding: 0.8rem; 
                gap: 0.6rem; box-shadow: 0 8px 30px rgba(0,0,0,0.06); 
                border-radius: 8px; 
            }
            .nav-links.show { display: flex; }
            .menu-toggle { display: block; }
            .hero { padding-top: 100px; }
            .product-image { height: 180px; }
            .checkout-content { 
                width: 100%; height: 100%; border-radius: 0; max-height: 100vh; 
            }
            .cart-sidebar { width: 100%; right: -110%; }
            .cart-sidebar.open { right: 0; }
        }
        
        @media (max-width: 420px) {
            .hero h1 { font-size: 1.6rem; }
            .product-image { height: 160px; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <nav>
            <div class="logo" onclick="showPage('hem')">TreeOfLifa</div>

            <ul class="nav-links" id="nav-links">
                <li><a onclick="showPage('hem')">Hem</a></li>
                <li><a onclick="showPage('om-oss')">Om oss</a></li>
                <li><a onclick="showPage('produkter')">Produkter</a></li>
            </ul>

            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="cart-icon" onclick="toggleCart()" aria-label="Öppna kundvagn">
                    🛒 <span class="cart-count" id="cart-count">0</span>
                </div>
                <button class="menu-toggle" id="menu-toggle" aria-label="Meny" onclick="toggleNav()">☰</button>
            </div>
        </nav>
    </header>

    <!-- Hem page (hero) -->
    <main>
        <section id="hem" class="page active" style="padding-top: 80px;">
            <div class="hero">
                <div>
                    <h1>Naturens Rena Skönhet</h1>
                    <p class="subtitle">Upptäck våra handplockade, ekologiska luffasvampar för en naturlig hudvård</p>
                    <button class="cta-button" onclick="showPage('produkter')">Utforska Produkter</button>
                </div>
            </div>

            <section class="section">
                <h2>Varför Välja TreeOfLifa?</h2>
                <p>Vi tror på naturens kraft att vårda och förnya din hud. Våra luffasvampar odlas med kärlek och respekt för miljön, vilket ger dig den bästa naturliga exfolieringen för en strålande, hälsosam hy.</p>
            </section>
        </section>

        <!-- Om oss -->
        <section id="om-oss" class="page" style="padding-top: 80px;">
            <div class="section">
                <h2>Vår Berättelse</h2>
                <p>TreeOfLifa grundades ur en passion för naturlig skönhet och hållbar livsstil. Vi startade vår resa med en enkel övertygelse: att naturen erbjuder de bästa lösningarna för hudvård.</p>
                <br>
                <p>Vårt team består av naturentusiaster som arbetar direkt med lokala odlare för att säkerställa att varje luffasvamp är av högsta kvalitet. Vi tror på transparent handel och miljövänliga metoder i varje steg av vår process.</p>
            </div>
        </section>

        <!-- Produkter -->
        <section id="produkter" class="page" style="padding-top: 80px;">
            <div class="section">
                <h2>Vårt Naturliga Sortiment</h2>
                <p>Upptäck vår exklusiva kollektion av handplockade, ekologiska luffasvampar. Varje produkt är noggrant utvald för att ge dig den bästa naturliga exfolieringen.</p>

                <div class="products-grid" id="products-grid">
                    <div class="product-card">
                        <div class="product-image no-image">🧽</div>
                        <div class="product-info">
                            <h3>Mindre Lifah</h3>
                            <p>Vår populäraste luffasvamp, lite kompaktare, perfekt för daglig användning.</p>
                            <div class="price">50 kr</div>
                            <button class="buy-button" onclick="addToCart('Mindre Lifah', 50)">Lägg i kundvagn</button>
                        </div>
                    </div>

                    <div class="product-card">
                        <div class="product-image no-image">🧽</div>
                        <div class="product-info">
                            <h3>Större Lifah</h3>
                            <p>Extra tjock och hållbar luffasvamp för djup rengöring.</p>
                            <div class="price">75 kr</div>
                            <button class="buy-button" onclick="addToCart('Större Lifah', 75)">Lägg i kundvagn</button>
                        </div>
                    </div>

                    <div class="product-card">
                        <div class="product-image no-image">🧼</div>
                        <div class="product-info">
                            <h3>Aleppotvål</h3>
                            <p>En mild 100% naturlig tvål som är gjord på ett urgammalt recept.</p>
                            <div class="price">50 kr</div>
                            <button class="buy-button" onclick="addToCart('Aleppotvål', 50)">Lägg i kundvagn</button>
                        </div>
                    </div>

                    <div class="product-card">
                        <div class="product-image no-image">🎁</div>
                        <div class="product-info">
                            <h3>Presentset</h3>
                            <p>Komplett set i en fin presentask, perfekt som gåva.</p>
                            <div class="price">145 kr</div>
                            <button class="buy-button" onclick="addToCart('Presentset', 145)">Lägg i kundvagn</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Cart overlay & sidebar -->
    <div class="cart-overlay" id="cart-overlay" onclick="toggleCart()"></div>
    <aside class="cart-sidebar" id="cart-sidebar" aria-hidden="true">
        <div class="cart-header">
            <h2>Kundvagn</h2>
            <button class="close-cart" onclick="toggleCart()">×</button>
        </div>

        <div class="cart-content" id="cart-content">
            <div class="empty-cart" id="empty-cart" style="text-align: center; padding: 2rem;">
                <div style="font-size: 2.2rem; color: #ccc;">🛒</div>
                <p>Din kundvagn är tom</p>
            </div>
        </div>

        <div class="cart-total" id="cart-total" style="display: none;">
            <div class="total-amount" id="total-amount">Totalt: 0 kr</div>
            <button class="checkout-button" onclick="showCheckout()">Gå till kassan</button>
        </div>
    </aside>

    <!-- Checkout modal -->
    <div class="checkout-modal" id="checkout-modal" aria-hidden="true">
        <div class="checkout-content" role="dialog" aria-labelledby="checkout-heading">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem;">
                <h2 id="checkout-heading">Slutför ditt köp</h2>
                <button class="close-cart" onclick="closeCheckout()">×</button>
            </div>

            <div id="payment-status" style="margin-bottom: 1rem;"></div>

            <form id="checkout-form" onsubmit="placeOrder(event)">
                <div class="form-group">
                    <label>Leveransadress</label>
                    <input type="text" id="namn" name="namn" placeholder="Namn" required />
                    <input type="text" id="adress" name="adress" placeholder="Adress" style="margin-top: 0.5rem;" required />
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <input type="text" id="postnummer" name="postnummer" placeholder="Postnummer" required />
                        <input type="text" id="stad" name="stad" placeholder="Stad" required />
                    </div>
                    <input type="email" id="email" name="email" placeholder="E-post" style="margin-top: 0.5rem;" required />
                    <input type="tel" id="telefon" name="telefon" placeholder="Telefon" style="margin-top: 0.5rem;" required />
                </div>

                <div class="payment-methods">
                    <h3 style="margin-bottom: 0.6rem;">Välj betalmetod</h3>

                    <div class="payment-method" onclick="selectPayment(event,'card')">
                        <input type="radio" name="payment" value="card">
                        <span class="payment-icon">💳</span>
                        <div><strong>Kort</strong><br><small>Betala säkert med kort</small></div>
                    </div>

                    <div class="payment-method" onclick="selectPayment(event,'paypal')">
                        <input type="radio" name="payment" value="paypal">
                        <span class="payment-icon">💰</span>
                        <div><strong>PayPal</strong><br><small>Betala säkert med PayPal</small></div>
                    </div>
                </div>

                <div id="card-details" style="display: none; margin-top: 0.6rem;">
                    <div class="form-group">
                        <label>Kortuppgifter</label>
                        <div id="card-element"></div>
                        <div id="card-errors" role="alert"></div>
                    </div>
                </div>

                <!-- PayPal Button Container -->
                <div id="paypal-button-container" style="display: none; margin-top: 1rem;"></div>

                <div style="margin-top: 1rem; padding: 0.9rem; background: #f8fffe; border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.4rem;">
                        <span>Produkter:</span>
                        <span id="checkout-subtotal">0 kr</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.4rem;">
                        <span>Frakt:</span>
                        <span>49 kr</span>
                    </div>
                    <hr style="border: none; height: 1px; background: #e8e8e8; margin: 0.6rem 0;">
                    <div style="display: flex; justify-content: space-between; font-weight: 700;">
                        <span>Totalt:</span>
                        <span id="checkout-total">49 kr</span>
                    </div>
                </div>

                <button type="submit" class="order-button" id="submit-button" style="margin-top: 1rem;">Slutför beställning</button>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <h3 style="color: #7fb069; margin-bottom: 0.6rem;">TreeOfLifa</h3>
            <p>Naturlig skönhet, hållbar framtid</p>
            <p style="margin-top: 0.4rem;">Kontakta oss: tree.of.liifa@gmail.com</p>
        </div>
    </footer>

    <script>
        // ===== Global State =====
        let cart = [];
        let isCartOpen = false;
        let isProcessingPayment = false;
        let stripe = null;
        let elements = null;
        let cardElement = null;
        let stripeInitialized = false;

        // ===== Configuration =====
        const STRIPE_PUBLISHABLE_KEY = "pk_test_51QMaGPQ2W4lqdp6blnxdZ4PI582jLSsnjDznejPKX3wSDDQ8PKEQVaZnqPeY22L0pekbSN7nyAt05B7OKqDDPyeg00QM3TiCAA";
        const BACKEND_URL = 'https://din-vercel-backend-url.vercel.app'; // Ersätt med din faktiska Vercel URL

        // ===== Utility Functions =====
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function showStatusMessage(message, type = 'info') {
            const statusContainer = document.getElementById('payment-status');
            if (statusContainer) {
                statusContainer.innerHTML = `<div class="${type}-message">${message}</div>`;
                
                if (type === 'info') {
                    setTimeout(() => {
                        statusContainer.innerHTML = '';
                    }, 5000);
                }
            }
        }

        // ===== Stripe Initialization =====
        async function initializeStripe() {
            try {
                if (stripeInitialized) return true;
                
                if (typeof Stripe === 'undefined') {
                    console.error('Stripe SDK not loaded');
                    return false;
                }

                stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                elements = stripe.elements({
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#4a7c59',
                            colorBackground: '#ffffff',
                            colorText: '#30313d',
                            colorDanger: '#df1b41',
                            fontFamily: 'Georgia, serif',
                            spacingUnit: '4px',
                            borderRadius: '8px'
                        }
                    }
                });
                
                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                        invalid: {
                            color: '#9e2146',
                        },
                    },
                });

                cardElement.mount('#card-element');
                
                cardElement.on('change', (event) => {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });

                stripeInitialized = true;
                return true;
            } catch (error) {
                console.error('Error initializing Stripe:', error);
                return false;
            }
        }

        async function initializePayPal() {
            try {
                if (typeof paypal === 'undefined') {
                    console.error('PayPal SDK not loaded');
                    return false;
                }

                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const total = subtotal + 49; // Including shipping

                await paypal.Buttons({
                    createOrder: (data, actions) => {
                        return actions.order.create({
                            purchase_units: [{
                                amount: {
                                    value: (total / 10).toFixed(2), // Convert SEK to approximate EUR for demo
                                    currency_code: 'EUR'
                                },
                                description: 'TreeOfLifa Natural Products'
                            }]
                        });
                    },
                    onApprove: async (data, actions) => {
                        try {
                            const order = await actions.order.capture();
                            console.log('PayPal payment successful:', order);
                            
                            const orderData = {
                                orderId: 'ORD-' + Date.now(),
                                transactionId: order.id,
                                items: cart.map(item => ({...item})),
                                subtotal: subtotal,
                                shipping: 49,
                                total: total,
                                paymentMethod: 'paypal',
                                customer: {
                                    name: document.getElementById('namn').value,
                                    address: document.getElementById('adress').value,
                                    postalCode: document.getElementById('postnummer').value,
                                    city: document.getElementById('stad').value,
                                    email: document.getElementById('email').value,
                                    phone: document.getElementById('telefon').value
                                },
                                timestamp: new Date().toISOString()
                            };

                            showSuccessMessage(orderData);
                            
                            // Clear cart and close
                            cart = [];
                            updateCartDisplay();
                            closeCheckout();
                            toggleCart();
                            
                        } catch (error) {
                            console.error('PayPal capture error:', error);
                            showStatusMessage('PayPal-betalningen misslyckades. Försök igen.', 'error');
                        }
                    },
                    onError: (err) => {
                        console.error('PayPal error:', err);
                        showStatusMessage('PayPal-betalningen misslyckades. Försök igen.', 'error');
                    }
                }).render('#paypal-button-container');

                return true;
            } catch (error) {
                console.error('Error initializing PayPal:', error);
                return false;
            }
        }

        // ===== Navigation Functions =====
        function showPage(pageId) {
            try {
                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                // Show selected page
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    closeNav();
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            } catch (error) {
                console.error('Error navigating to page:', error);
            }
        }

        function toggleNav() {
            try {
                const nav = document.getElementById('nav-links');
                if (nav) {
                    nav.classList.toggle('show');
                }
            } catch (error) {
                console.error('Error toggling navigation:', error);
            }
        }

        function closeNav() {
            try {
                const nav = document.getElementById('nav-links');
                if (nav) {
                    nav.classList.remove('show');
                }
            } catch (error) {
                console.error('Error closing navigation:', error);
            }
        }

        // ===== Cart Functions =====
        function addToCart(name, price) {
            try {
                if (!name || typeof price !== 'number') {
                    console.error('Invalid parameters for addToCart');
                    return;
                }

                const existing = cart.find(item => item.name === name);
                if (existing) {
                    existing.quantity += 1;
                } else {
                    cart.push({ name, price, quantity: 1 });
                }
                
                updateCartDisplay();
                showCartNotification(name);
            } catch (error) {
                console.error('Error adding to cart:', error);
            }
        }

        function removeFromCart(name) {
            try {
                cart = cart.filter(item => item.name !== name);
                updateCartDisplay();
            } catch (error) {
                console.error('Error removing from cart:', error);
            }
        }

        function updateQuantity(name, change) {
            try {
                const item = cart.find(i => i.name === name);
                if (!item) {
                    console.error(`Product '${name}' not found in cart`);
                    return;
                }
                
                item.quantity += change;
                
                if (item.quantity <= 0) {
                    removeFromCart(name);
                } else {
                    updateCartDisplay();
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
            }
        }

        function updateCartDisplay() {
            try {
                const cartCount = document.getElementById('cart-count');
                const cartContent = document.getElementById('cart-content');
                const cartTotal = document.getElementById('cart-total');
                const emptyCart = document.getElementById('empty-cart');
                const totalAmountEl = document.getElementById('total-amount');

                if (!cartCount || !cartContent) {
                    console.error('Cart DOM elements not found');
                    return;
                }

                const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                // Update counter
                cartCount.textContent = itemCount;

                // Handle empty cart
                if (cart.length === 0) {
                    if (emptyCart) emptyCart.style.display = 'block';
                    if (cartTotal) cartTotal.style.display = 'none';
                    
                    cartContent.innerHTML = `
                        <div class="empty-cart" style="text-align:center; padding:2rem;">
                            <div style="font-size:2.2rem; color:#ccc;">🛒</div>
                            <p>Din kundvagn är tom</p>
                        </div>
                    `;
                } else {
                    // Show cart with content
                    if (emptyCart) emptyCart.style.display = 'none';
                    if (cartTotal) cartTotal.style.display = 'block';
                    
                    cartContent.innerHTML = cart.map(item => `
                        <div class="cart-item">
                            <div>
                                <strong>${escapeHtml(item.name)}</strong>
                                <div style="color:#777">${item.price} kr</div>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div class="quantity-controls">
                                    <button class="quantity-btn" onclick="updateQuantity('${escapeHtml(item.name)}', -1)">−</button>
                                    <span style="margin:0 6px;">${item.quantity}</span>
                                    <button class="quantity-btn" onclick="updateQuantity('${escapeHtml(item.name)}', 1)">+</button>
                                </div>
                                <button style="background:none; border:none; color:#999; cursor:pointer;" 
                                        onclick="removeFromCart('${escapeHtml(item.name)}')">
                                    Ta bort
                                </button>
                            </div>
                        </div>
                    `).join('');
                    
                    // Update total
                    if (totalAmountEl) {
                        totalAmountEl.textContent = `Totalt: ${total} kr`;
                    }
                }

                // Update checkout totals
                updateCheckoutTotals(total);
                
            } catch (error) {
                console.error('Error updating cart display:', error);
            }
        }

        function updateCheckoutTotals(subtotal) {
            try {
                const checkoutSubtotal = document.getElementById('checkout-subtotal');
                const checkoutTotal = document.getElementById('checkout-total');
                const shippingCost = 49;
                
                if (checkoutSubtotal) checkoutSubtotal.textContent = `${subtotal} kr`;
                if (checkoutTotal) checkoutTotal.textContent = `${subtotal + shippingCost} kr`;
            } catch (error) {
                console.error('Error updating checkout totals:', error);
            }
        }

        function showCartNotification(productName) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 100px; right: 20px; 
                background: #4a7c59; color: white; 
                padding: 1rem; border-radius: 8px; 
                z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(100%); transition: transform 0.3s ease;
            `;
            notification.textContent = `${productName} tillagd i kundvagnen!`;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function toggleCart() {
            try {
                const overlay = document.getElementById('cart-overlay');
                const sidebar = document.getElementById('cart-sidebar');
                
                if (!overlay || !sidebar) {
                    console.error('Cart DOM elements not found');
                    return;
                }

                isCartOpen = !isCartOpen;
                
                if (isCartOpen) {
                    overlay.classList.add('show');
                    sidebar.classList.add('open');
                    sidebar.setAttribute('aria-hidden', 'false');
                    document.body.style.overflow = 'hidden';
                } else {
                    overlay.classList.remove('show');
                    sidebar.classList.remove('open');
                    sidebar.setAttribute('aria-hidden', 'true');
                    document.body.style.overflow = '';
                }
            } catch (error) {
                console.error('Error toggling cart:', error);
            }
        }

        // ===== Checkout Functions =====
        async function showCheckout() {
            try {
                if (cart.length === 0) {
                    showStatusMessage('Din kundvagn är tom', 'error');
                    return;
                }

                const modal = document.getElementById('checkout-modal');
                if (modal) {
                    modal.classList.add('show');
                    modal.setAttribute('aria-hidden', 'false');
                    
                    // Initialize Stripe when showing checkout
                    await initializeStripe();
                    
                    // Focus on first input
                    const firstInput = modal.querySelector('input');
                    if (firstInput) firstInput.focus();
                }
            } catch (error) {
                console.error('Error showing checkout:', error);
            }
        }

        function closeCheckout() {
            try {
                const modal = document.getElementById('checkout-modal');
                if (modal) {
                    modal.classList.remove('show');
                    modal.setAttribute('aria-hidden', 'true');
                    
                    // Clear status messages
                    const statusContainer = document.getElementById('payment-status');
                    if (statusContainer) {
                        statusContainer.innerHTML = '';
                    }

                    // Hide PayPal buttons
                    const paypalContainer = document.getElementById('paypal-button-container');
                    if (paypalContainer) {
                        paypalContainer.style.display = 'none';
                        paypalContainer.innerHTML = '';
                    }
                }
            } catch (error) {
                console.error('Error closing checkout:', error);
            }
        }

        async function selectPayment(event, paymentType) {
            try {
                event.stopPropagation();
                
                // Remove previous selection
                document.querySelectorAll('.payment-method').forEach(method => {
                    method.classList.remove('selected');
                });
                
                // Mark selected method
                const selectedMethod = event.currentTarget;
                selectedMethod.classList.add('selected');
                
                // Set radio button
                const radio = selectedMethod.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;
                
                // Show/hide payment elements
                const cardDetails = document.getElementById('card-details');
                const submitButton = document.getElementById('submit-button');
                const paypalContainer = document.getElementById('paypal-button-container');
                
                if (paymentType === 'card') {
                    if (cardDetails) cardDetails.style.display = 'block';
                    if (submitButton) submitButton.style.display = 'block';
                    if (paypalContainer) paypalContainer.style.display = 'none';
                    
                    // Initialize Stripe if not already done
                    await initializeStripe();
                    
                } else if (paymentType === 'paypal') {
                    if (cardDetails) cardDetails.style.display = 'none';
                    if (submitButton) submitButton.style.display = 'none';
                    if (paypalContainer) {
                        paypalContainer.style.display = 'block';
                        paypalContainer.innerHTML = ''; // Clear previous buttons
                        await initializePayPal();
                    }
                }
                
            } catch (error) {
                console.error('Error selecting payment method:', error);
            }
        }

        async function placeOrder(event) {
            try {
                event.preventDefault();
                
                if (isProcessingPayment) {
                    return;
                }
                
                // Validate payment method is selected
                const selectedPayment = document.querySelector('input[name="payment"]:checked');
                if (!selectedPayment) {
                    showStatusMessage('Vänligen välj en betalmetod', 'error');
                    return;
                }

                // Validate cart
                if (cart.length === 0) {
                    showStatusMessage('Din kundvagn är tom', 'error');
                    return;
                }

                // Validate form
                const form = document.getElementById('checkout-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const paymentMethod = selectedPayment.value;

                if (paymentMethod === 'card') {
                    await processStripePayment();
                } else {
                    // PayPal is handled by its own buttons
                    showStatusMessage('Använd PayPal-knappen för att slutföra betalningen', 'info');
                }

            } catch (error) {
                console.error('Error placing order:', error);
                showStatusMessage('Ett fel uppstod vid beställningen. Försök igen.', 'error');
                setPaymentProcessing(false);
            }
        }

        async function processStripePayment() {
            try {
                if (!stripe || !cardElement) {
                    showStatusMessage('Stripe är inte initialiserat. Försök igen.', 'error');
                    return;
                }

                setPaymentProcessing(true);
                showStatusMessage('Skapar betalning...', 'info');

                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const total = subtotal + 49; // Including shipping

                // Create payment intent on your backend
                const response = await fetch(`${BACKEND_URL}/create-payment-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: total * 100, // Stripe expects amount in öre (cents)
                        currency: 'sek',
                        customer: {
                            name: document.getElementById('namn').value,
                            email: document.getElementById('email').value,
                            address: {
                                line1: document.getElementById('adress').value,
                                postal_code: document.getElementById('postnummer').value,
                                city: document.getElementById('stad').value,
                                country: 'SE'
                            }
                        },
                        items: cart,
                        metadata: {
                            orderId: 'ORD-' + Date.now(),
                            phone: document.getElementById('telefon').value
                        }
                    }),
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const { clientSecret } = await response.json();
                
                showStatusMessage('Behandlar kortbetalning...', 'info');

                // Confirm payment with Stripe
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: document.getElementById('namn').value,
                            email: document.getElementById('email').value,
                            address: {
                                line1: document.getElementById('adress').value,
                                postal_code: document.getElementById('postnummer').value,
                                city: document.getElementById('stad').value,
                                country: 'SE'
                            }
                        }
                    }
                });

                if (error) {
                    console.error('Payment confirmation error:', error);
                    showStatusMessage(error.message, 'error');
                    setPaymentProcessing(false);
                    return;
                }

                if (paymentIntent.status === 'succeeded') {
                    const orderData = {
                        orderId: paymentIntent.metadata.orderId,
                        transactionId: paymentIntent.id,
                        items: cart.map(item => ({...item})),
                        subtotal: subtotal,
                        shipping: 49,
                        total: total,
                        paymentMethod: 'card',
                        customer: {
                            name: document.getElementById('namn').value,
                            address: document.getElementById('adress').value,
                            postalCode: document.getElementById('postnummer').value,
                            city: document.getElementById('stad').value,
                            email: document.getElementById('email').value,
                            phone: document.getElementById('telefon').value
                        },
                        timestamp: new Date().toISOString()
                    };

                    showSuccessMessage(orderData);
                    
                    // Clear cart and close
                    cart = [];
                    updateCartDisplay();
                    closeCheckout();
                    toggleCart();
                } else {
                    showStatusMessage('Betalningen kunde inte slutföras. Status: ' + paymentIntent.status, 'error');
                }

                setPaymentProcessing(false);

            } catch (error) {
                console.error('Stripe payment error:', error);
                
                // Fallback to demo mode if backend is not available
                if (error.message.includes('fetch') || error.message.includes('Network')) {
                    showStatusMessage('Backend ej tillgänglig - kör i demo-läge', 'info');
                    await processDemoPayment();
                } else {
                    showStatusMessage('Ett fel uppstod vid kortbetalningen. Försök igen.', 'error');
                    setPaymentProcessing(false);
                }
            }
        }

        async function processDemoPayment() {
            // Demo fallback when no backend is available
            showStatusMessage('Demo-läge: Simulerar betalning...', 'info');
            
            setTimeout(() => {
                const success = Math.random() > 0.1; // 90% success rate in demo
                
                if (success) {
                    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const orderData = {
                        orderId: 'DEMO-ORD-' + Date.now(),
                        transactionId: 'DEMO-TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                        items: cart.map(item => ({...item})),
                        subtotal: subtotal,
                        shipping: 49,
                        total: subtotal + 49,
                        paymentMethod: 'card',
                        customer: {
                            name: document.getElementById('namn').value,
                            address: document.getElementById('adress').value,
                            postalCode: document.getElementById('postnummer').value,
                            city: document.getElementById('stad').value,
                            email: document.getElementById('email').value,
                            phone: document.getElementById('telefon').value
                        },
                        timestamp: new Date().toISOString()
                    };

                    showSuccessMessage(orderData);
                    
                    // Clear cart and close
                    cart = [];
                    updateCartDisplay();
                    closeCheckout();
                    toggleCart();
                } else {
                    showStatusMessage('Demo: Kortbetalningen nekades. Försök igen.', 'error');
                }
                
                setPaymentProcessing(false);
            }, 2000);
        }

        function setPaymentProcessing(processing) {
            isProcessingPayment = processing;
            const submitButton = document.getElementById('submit-button');
            const checkoutContent = document.querySelector('.checkout-content');
            
            if (processing) {
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Behandlar betalning...';
                }
                if (checkoutContent) {
                    checkoutContent.classList.add('payment-processing');
                }
            } else {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Slutför beställning';
                }
                if (checkoutContent) {
                    checkoutContent.classList.remove('payment-processing');
                }
            }
        }

        function showSuccessMessage(orderData) {
            const message = document.createElement('div');
            message.className = 'success-message';
            message.innerHTML = `
                <h3>Tack för din beställning! 🎉</h3>
                <p><strong>Ordernummer:</strong> ${orderData.orderId}</p>
                <p><strong>Total:</strong> ${orderData.total} kr</p>
                <p>Vi har skickat en bekräftelse till <strong>${orderData.customer.email}</strong></p>
                <p>Din beställning kommer att skickas inom 2-3 arbetsdagar till:</p>
                <p><strong>${orderData.customer.name}</strong><br>
                ${orderData.customer.address}<br>
                ${orderData.customer.postalCode} ${orderData.customer.city}</p>
                <button onclick="this.parentElement.remove()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: white; color: #4a7c59; border: 2px solid #4a7c59; border-radius: 6px; cursor: pointer;">
                    Stäng
                </button>
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (document.body.contains(message)) {
                    document.body.removeChild(message);
                }
            }, 15000);
        }

        // ===== Event Listeners =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('TreeOfLifa website loaded');
            
            // Close modals with ESC
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    if (document.getElementById('checkout-modal').classList.contains('show')) {
                        closeCheckout();
                    } else if (isCartOpen) {
                        toggleCart();
                    }
                }
            });

            // Close mobile navigation when clicking outside
            document.addEventListener('click', function(event) {
                const nav = document.getElementById('nav-links');
                const menuToggle = document.getElementById('menu-toggle');
                
                if (nav && nav.classList.contains('show') && 
                    !nav.contains(event.target) && 
                    event.target !== menuToggle) {
                    closeNav();
                }
            });

            console.log('TreeOfLifa website fully loaded');
        });
    </script>
</body>
</html>
